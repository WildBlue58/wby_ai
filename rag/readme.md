# RAG

- Function Call 给LLM 提供工具和服务
- MCP 定义了LLM 与外部资源的通信协议
RAG(检索增强生成)是一种通过从外部知识库检索相关信息并将其融入提示词，来增强大语言模型生成内容的准确性、时效性和相关性的技术框架。

- 增强？
  给LLM 提供丰富的上下文
- 检索？
  律师、PPT、Code 知识库

  prompt -> 知识库(检索embedding) -> prompt + 知识库(相关) -> LLM
  返回结果

- 检索
  如何在知识库里，根据prompt找到相关的那一段内容交给大模型

  - embedding
    将文本转换为高维向量，用于语义相似度计算
    相似的文本在向量空间中距离更近
    常用模型：OpenAI text-embedding-ada-002、BGE、M3E 等

## RAG 完整工作流程

1. **文档预处理**
   - 文档加载（PDF、Word、Markdown 等）
   - 文本分割（Chunking）- 将长文档切分为小块
   - 常见策略：固定大小、按段落、按语义分割

2. **向量化（Embedding）**
   - 使用 Embedding 模型将文本块转换为向量
   - 向量存储在向量数据库中

3. **查询处理**
   - 用户输入查询（Query）
   - 将查询转换为向量（Query Embedding）

4. **相似度检索**
   - 在向量数据库中搜索最相似的文档块
   - 常用方法：余弦相似度、欧氏距离、点积
   - 返回 Top-K 个最相关的文档片段

5. **上下文增强**
   - 将检索到的文档片段作为上下文
   - 与原始查询一起构建增强的 Prompt

6. **生成回答**
   - LLM 基于增强的 Prompt 生成回答
   - 回答更加准确、相关，且可追溯来源

## 技术栈

### 向量数据库

- **Pinecone**: 云端托管向量数据库
- **Weaviate**: 开源向量搜索引擎
- **Milvus**: 高性能向量数据库
- **Chroma**: 轻量级嵌入式向量数据库
- **Qdrant**: Rust 编写的高性能向量数据库
- **FAISS**: Facebook 开源相似度搜索库

### Embedding 模型

- **OpenAI**: text-embedding-ada-002, text-embedding-3-small/large
- **国产模型**: BGE-large-zh, M3E-base/large, text2vec
- **开源模型**: Sentence-BERT, E5, BGE-M3

### 框架和工具

- **LangChain**: RAG 应用开发框架
- **LlamaIndex**: 数据连接和 RAG 框架
- **Haystack**: 端到端 NLP 框架
- **Dify**: 低代码 LLM 应用开发平台

## 应用场景

- **智能问答系统**: 基于企业内部文档的问答
- **代码助手**: 基于代码库的编程辅助
- **法律咨询**: 基于法律文档的智能咨询
- **医疗诊断辅助**: 基于医学文献的诊断支持
- **客服机器人**: 基于产品文档的客户服务
- **知识管理**: 企业知识库的智能检索

## RAG 的优势

- ✅ **准确性提升**: 基于真实文档，减少幻觉
- ✅ **时效性**: 可以更新知识库，无需重新训练模型
- ✅ **可追溯性**: 可以标注答案来源
- ✅ **成本效益**: 无需微调大模型
- ✅ **领域适应**: 可以快速适配特定领域

## RAG 的挑战

- ⚠️ **检索质量**: 检索不到相关内容会影响回答质量
- ⚠️ **上下文长度限制**: LLM 的上下文窗口有限
- ⚠️ **文档分割策略**: 如何切分文档影响检索效果
- ⚠️ **多跳推理**: 需要组合多个文档片段时较困难
- ⚠️ **实时性**: 向量检索和生成需要时间

## 优化策略

- **混合检索**: 结合向量检索和关键词检索（BM25）
- **重排序（Rerank）**: 使用专门的模型对检索结果重新排序
- **查询扩展**: 使用 LLM 扩展查询，提高检索覆盖率
- **元数据过滤**: 结合文档元数据（时间、作者等）进行过滤
- **多模态 RAG**: 支持图片、表格等多模态内容
