# 教务系统成绩导出工具使用说明

## 问题分析

您遇到的"文件格式损坏"问题主要是由于以下原因：

1. **权限问题**：服务器返回了"无功能权限"的HTML页面，而不是Excel文件
2. **请求头不完整**：缺少必要的认证信息和CSRF Token
3. **请求方式不当**：没有正确模拟浏览器的请求行为

## 解决方案

我为您提供了两个改进版本的插件：

### 版本1：改进版插件 (`improved_grade_exporter.js`)

**特点：**
- 添加了完整的请求头信息
- 包含CSRF Token认证
- 使用XLSX库处理Excel文件
- 支持卷面分和平时分的智能分离

**使用方法：**
1. 将代码复制到Tampermonkey中
2. 确保已登录教务系统
3. 进入成绩查询页面
4. 点击右上角的"导出Excel成绩"或"导出详细成绩"按钮

### 版本2：简化版插件 (`simple_grade_exporter.js`)

**特点：**
- 直接从页面读取成绩数据
- 生成标准的Excel/CSV文件
- 避免复杂的权限问题
- 更稳定可靠

**使用方法：**
1. 将代码复制到Tampermonkey中
2. 确保成绩页面已完全加载
3. 点击右上角的"导出成绩"或"导出CSV"按钮

## 安装步骤

### 1. 安装Tampermonkey扩展
- Chrome浏览器：在Chrome网上应用店搜索"Tampermonkey"
- Firefox浏览器：在Firefox附加组件中搜索"Tampermonkey"

### 2. 创建新脚本
1. 点击Tampermonkey图标
2. 选择"创建新脚本"
3. 删除默认代码
4. 复制上述任一版本的代码
5. 按Ctrl+S保存

### 3. 使用插件
1. 登录您的教务系统
2. 进入成绩查询页面
3. 等待页面完全加载
4. 点击右上角出现的导出按钮

## 功能说明

### 卷面分和平时分分离逻辑

插件会根据以下规则分离成绩：

1. **明确标识**：如果成绩类型包含"卷面"、"考试"等关键词，直接归类为卷面分
2. **平时成绩**：如果成绩类型包含"平时"、"作业"等关键词，直接归类为平时分
3. **智能估算**：对于没有明确分类的成绩，按70%卷面分、30%平时分的比例估算

### 文件格式

- **Excel格式**：`.xls`文件，可用Excel、WPS等软件打开
- **CSV格式**：`.csv`文件，可用Excel、记事本等软件打开

## 常见问题解决

### 1. 权限不足问题
**症状**：提示"无功能权限"
**解决**：
- 确保已正确登录教务系统
- 刷新页面后重试
- 使用简化版插件

### 2. 文件格式损坏
**症状**：Excel文件无法打开
**解决**：
- 使用简化版插件
- 尝试导出CSV格式
- 检查网络连接

### 3. 数据不完整
**症状**：导出的成绩数据缺失
**解决**：
- 确保成绩页面已完全加载
- 检查是否有分页，需要翻页获取所有数据
- 刷新页面后重试

### 4. 插件不显示
**症状**：右上角没有出现导出按钮
**解决**：
- 检查Tampermonkey是否启用
- 确认脚本已正确安装
- 刷新页面

## 技术原理

### 权限问题解决
- 添加完整的请求头信息
- 包含CSRF Token认证
- 模拟真实的浏览器请求

### 数据获取方式
1. **API请求**：直接调用教务系统的导出接口
2. **页面解析**：从已加载的页面中提取成绩数据

### 文件生成
- 使用标准的Excel格式
- 添加UTF-8 BOM确保中文正确显示
- 支持CSV格式作为备选

## 注意事项

1. **仅限个人使用**：请勿用于商业用途
2. **遵守校规**：使用插件时请遵守学校相关规定
3. **数据准确性**：导出的数据仅供参考，以教务系统官方数据为准
4. **定期更新**：如教务系统更新，可能需要相应调整插件

## 联系支持

如果遇到问题，请：
1. 检查浏览器控制台的错误信息
2. 确认教务系统是否正常访问
3. 尝试使用不同版本的插件

---

**免责声明**：本工具仅供学习和个人使用，使用者需自行承担使用风险。 