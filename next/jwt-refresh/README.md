# Next.js JWT åŒTokenè®¤è¯é¡¹ç›®

ä¸€ä¸ªåŸºäºNext.js 15çš„å…¨æ ˆé¡¹ç›®ï¼Œå®ç°äº†å®‰å…¨çš„JWTåŒTokenè®¤è¯ç³»ç»Ÿã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

- âœ… **ç”¨æˆ·è®¤è¯ç³»ç»Ÿ** - æ³¨å†Œã€ç™»å½•ã€JWTåŒTokenè®¤è¯
- âœ… **æ–‡ç« ç®¡ç†ç³»ç»Ÿ** - åˆ›å»ºã€æŸ¥çœ‹æ–‡ç« 
- âœ… **å®‰å…¨ä¸­é—´ä»¶** - è·¯ç”±ä¿æŠ¤å’Œè‡ªåŠ¨Tokenåˆ·æ–°
- âœ… **æ•°æ®åº“é›†æˆ** - Prisma ORM + MySQL
- âœ… **ç±»å‹å®‰å…¨** - å®Œæ•´çš„TypeScriptæ”¯æŒ
- âœ… **ç°ä»£åŒ–UI** - Tailwind CSSå“åº”å¼è®¾è®¡

## ğŸ” åŒTokenè®¤è¯æœºåˆ¶

### ä¸ºä»€ä¹ˆä½¿ç”¨åŒTokenï¼Ÿ

å•Tokenå­˜å‚¨åœ¨localStorageä¸­é•¿æœŸä¿å­˜å®¹æ˜“è¢«ç¬¬ä¸‰æ–¹æ‹¦æˆªï¼Œå­˜åœ¨å®‰å…¨é£é™©ã€‚åŒTokenæœºåˆ¶æä¾›äº†æ›´å¥½çš„å®‰å…¨æ€§ï¼š

- **AccessToken** - ç”¨äºèº«ä»½éªŒè¯ï¼Œæœ‰æ•ˆæœŸçŸ­ï¼ˆ15åˆ†é’Ÿï¼‰ï¼Œå­˜å‚¨åœ¨HttpOnly Cookieä¸­
- **RefreshToken** - ç”¨äºåˆ·æ–°AccessTokenï¼Œæœ‰æ•ˆæœŸé•¿ï¼ˆ7å¤©ï¼‰ï¼Œå­˜å‚¨åœ¨HttpOnly Cookieä¸­

### å·¥ä½œæµç¨‹

1. ç”¨æˆ·ç™»å½•åè·å¾—ä¸¤ä¸ªToken
2. AccessTokenè¿‡æœŸæ—¶ï¼Œè‡ªåŠ¨ä½¿ç”¨RefreshTokenåˆ·æ–°
3. RefreshTokenè¿‡æœŸæ—¶ï¼Œç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•
4. æ‰€æœ‰Tokenéƒ½å­˜å‚¨åœ¨HttpOnly Cookieä¸­ï¼Œé˜²æ­¢XSSæ”»å‡»

## å¼€å‘æµç¨‹

- .env
  mysql url
  create database jwt;å»ºç«‹æ•°æ®åº“
- prisma åˆå§‹åŒ–
  orm å·¥å…·
  object relation mapping
  User(è¡¨) => Userç±»
  ä¸€è¡Œ => new User() å®ä¾‹
  åº•å±‚æ•°æ®åº“æ“ä½œ æ˜ å°„æˆ é«˜çº§çš„é¢å‘å¯¹è±¡æ“ä½œ

- Prisma Schema æ˜¯å®šä¹‰æ•°æ®åº“æ¨¡å‹ã€å…³ç³»å’Œæ•°æ®ç±»å‹çš„é…ç½®æ–‡ä»¶ï¼Œç”¨äºç”Ÿæˆç±»å‹å®‰å…¨çš„æ•°æ®åº“å®¢æˆ·ç«¯ã€‚
  æ•°æ®åº“çš„è®¾è®¡å›¾
  navicat å¥½çš„åœ°æ–¹ï¼Œschema + git ç•™ä¸‹æ•°æ®åº“è®¾è®¡å’Œä¿®æ”¹çš„å†å²
  æ–‡æ¡£å‹çš„ï¼Œå¯ä»¥è¿½è¸ªã€‚ç•™åº•

- Model è¡¨çš„æ˜ å°„æ¨¡å‹
  @@map("users") æŒ‡å®šæ¨¡å‹å¯¹åº”çš„è¡¨å
  posts Post[] ä¸€å¯¹å¤šçš„å…³ç³»
  createdAt updatedAt prisma è‡ªåŠ¨ç»´æŠ¤
  @id ä¸»é”® @unique å”¯ä¸€ç´¢å¼•
  Model User{
    columns name type @default
    ç´¢å¼•
    relation
  }

  - migration è¿ç§»
      è®°å½•

- restful API
- lib/å¤ç”¨çš„js æ¨¡å—
- regexp
  å‰ç«¯ï¼Œåç«¯éƒ½è¦ä¼šæ­£åˆ™
  /^.+?[]{}$/ test
  ^ å¼€å§‹ $ ç»“æŸ ^$ ä¸¥æ ¼åŒ¹é…æ•´ä¸ªå­—ç¬¦
  ? 0æ¬¡æˆ–ä¸€æ¬¡
  -+ ä¸€æ¬¡æˆ–å¤šæ¬¡
  [] èŒƒå›´
  {} é•¿åº¦
- bcryptjs åŠ å¯†js æ¨¡å— å•é¡¹çš„åŠ å¯†ç®—æ³•(ä¸èƒ½è¢«è§£å¯†)
  register åŠ å¯†ä¸€æ¬¡
  login password åŠ å¯†ä¸€æ¬¡
  æ¯”è¾ƒçš„åŠ å¯†åçš„ä¸²æ˜¯å¦ä¸€æ ·ï¼Ÿ
- çŠ¶æ€ç 
  - 200 OK
  - 201 åˆ›å»º Created
  - 204 æ— å†…å®¹
  - 400 è¯·æ±‚é”™è¯¯ Bad Request
  - 401 æœªæˆæƒ Unauthorized Forbidden
  - 403 ç¦æ­¢è®¿é—®
  - 404 æœªæ‰¾åˆ° Not Found
  - 409 å†²çª Conflict
  - 500 æœåŠ¡å™¨é”™è¯¯ Internal Server Error

- middleware çš„æ¦‚å¿µ
  ä¸­é—´ä»¶ é…ç½®ä¸€ä¸ªåˆ—è¡¨
  /dashboard
  Middleware æ˜¯ä¸­é—´ä»¶ï¼Œç”¨äºåœ¨è¯·æ±‚å’Œå“åº”ä¹‹é—´æ‰§è¡Œé¢„å¤„ç†é€»è¾‘ï¼Œå¦‚æ—¥å¿—ã€è®¤è¯ã€æ•°æ®è§£æç­‰ã€‚
  - é…ç½®ä¸€ä¸ªéœ€è¦ç™»å½•çš„é¡µé¢æ•°ç»„
  - some startWith
  - response.next() æ”¾è¡Œ
  - response.redirect() è·³è½¬

  - é€šè¿‡jwt verifyæ–¹æ³•æ‹¿åˆ°payloadåï¼Œæ·»åŠ äº†è‡ªå®šä¹‰çš„è¯·æ±‚å¤´
    x-user-id
    åç»­é¡µé¢å°±å¯ä»¥æ‹¿åˆ°è¿™ä¸ªå€¼

- JWT çš„æ„æˆ
  - å¤´éƒ¨
    ç­¾åç®—æ³• HS256
  - è½½è·
    {userId:....}
  - ç­¾å
    secretKey

- cookie
  httpOnly:true
  HttpOnly å¯é˜²æ­¢ Javascript è®¿é—® Cookieï¼Œæœ‰æ•ˆæŠµå¾¡XSS æ”»å‡»å¯¼è‡´çš„ä»¤ç‰Œæ³„æ¼ã€‚
  æœåŠ¡å™¨ç«¯è®¾ç½®
  SameSite å¯é˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ (CSRF)æ”»å‡»ï¼Œé™åˆ¶ Cookie åœ¨è·¨åŸŸè¯·æ±‚ä¸­çš„è‡ªåŠ¨å‘é€ï¼Œæå‡å®‰å…¨æ€§ã€‚

- åç«¯å®‰å…¨å’Œæ€§èƒ½
  - ä¸€å®šè¦åšå®¹é”™å¤„ç†
    try{}catch{}finally{}
  - é‡Šæ”¾æ•°æ®åº“å¯¹è±¡
    await prisma.$disconnect();
- prisma client çš„CRUDæ–¹æ³•
  prisma.user.create()
  prisma.user.fineUnique()
  prisma.user.update({
    where:{},
    data:{}
  })
