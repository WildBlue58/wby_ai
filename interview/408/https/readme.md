# HTTP & HTTPS

## 基本概念

### HTTP (HyperText Transfer Protocol)

- **定义**：超文本传输协议，是一种用于传输超媒体文档的应用层协议
- **特点**：
  - 无状态协议（每次请求独立，不保存状态）
  - 明文传输（数据未加密）
  - 默认端口：80
  - 基于 TCP/IP 协议

### HTTPS (HyperText Transfer Protocol Secure)

- **定义**：安全的 HTTP 协议，在 HTTP 基础上增加了 SSL/TLS 加密层
- **特点**：
  - 加密传输（数据加密）
  - 身份认证（通过证书验证服务器身份）
  - 数据完整性（防止数据被篡改）
  - 默认端口：443
  - 基于 TCP/IP + SSL/TLS 协议

## HTTP vs HTTPS 对比

| 特性 | HTTP | HTTPS |
|------|------|-------|
| 协议 | 应用层协议 | 应用层协议 + SSL/TLS |
| 端口 | 80 | 443 |
| 加密 | 明文传输 | 加密传输 |
| 安全性 | 低（易被窃听、篡改） | 高（防窃听、防篡改） |
| 性能 | 较快 | 较慢（TLS 1.3 已优化） |
| 证书 | 不需要 | 需要 CA 证书 |
| SEO | 搜索引擎不优先 | 搜索引擎优先 |

## OSI 七层模型

```
应用层      →  提供用户接口，GET / HTTP FTP SMTP
  ↑
表示层      →  数据格式转换、加密解密、压缩解压
  ↑
会话层      →  Cookie & Session 会话管理
  ↑
传输层      →  TCP/UDP 端到端通信，可靠传输
  ↑
网络层      →  IP 地址，路由选择
  ↑
数据链路层  →  MAC 地址，帧传输
  ↑
物理层      →  物理介质，传输比特流
```

## HTTPS 工作原理

### 1. 为什么需要 HTTPS？

#### 中间人攻击（Man-in-the-Middle Attack）

- **问题**：HTTP 明文传输，攻击者可以：
  - 窃听数据（看到传输内容）
  - 篡改数据（修改传输内容）
  - 冒充服务器（伪造身份）

#### 解决方案：加密 + 身份认证

- 加密：防止数据被窃听
- 身份认证：防止中间人冒充

### 2. 加密方式

#### 对称加密

- **原理**：加密和解密使用同一把密钥
- **优点**：速度快，效率高
- **缺点**：密钥传输不安全（如何安全地传递密钥？）

#### 非对称加密

- **原理**：
  - 公钥：任何人都可以获取，用于加密数据
  - 私钥：只有拥有者持有，用于解密数据
- **特点**：
  - A 把公钥发给 B，B 用公钥加密数据，只有 A 的私钥能解密
  - 安全性高，但性能差（计算量大）

#### 混合加密（HTTPS 采用）

- **原理**：结合对称加密和非对称加密的优点
- **过程**：
  1. 使用非对称加密安全传输对称密钥
  2. 使用对称加密高效传输数据

### 3. HTTPS 建立过程（TLS 握手）

#### TLS 1.2 握手流程（4 次握手）

```
客户端                                   服务器
  |                                        |
  |-------- Client Hello ---------------->|
  |  支持的 TLS 版本                        |
  |  支持的加密套件                         |
  |  客户端随机数 (Client Random)           |
  |                                        |
  |<------- Server Hello -----------------|
  |  选择的 TLS 版本                        |
  |  选择的加密套件                         |
  |  服务器随机数 (Server Random)           |
  |                                        |
  |<------ Certificate -------------------|
  |  服务器证书（包含公钥）                  |
  |                                        |
  |<----- Server Hello Done --------------|
  |                                        |
  |-------- Client Key Exchange --------->|
  |  用服务器公钥加密的预主密钥              |
  |  (Pre-master Secret)                   |
  |                                        |
  |-------- Change Cipher Spec ---------->|
  |  切换到加密通信                         |
  |                                        |
  |-------- Finished (加密) ------------->|
  |                                        |
  |<------ Change Cipher Spec ------------|
  |                                        |
  |<------ Finished (加密) ----------------|
  |                                        |
  |======== 加密数据传输 ==================|
```

#### TLS 1.3 握手流程（优化后，1-RTT）

```
客户端                                   服务器
  |                                        |
  |-------- Client Hello ---------------->|
  |  支持的 TLS 版本                        |
  |  支持的加密套件                         |
  |  客户端随机数                           |
  |  密钥共享（Key Share）                  |
  |                                        |
  |<------- Server Hello -----------------|
  |  选择的 TLS 版本                        |
  |  选择的加密套件                         |
  |  服务器随机数                           |
  |  密钥共享（Key Share）                  |
  |  证书                                   |
  |  加密的 Finished                        |
  |                                        |
  |-------- Finished (加密) ------------->|
  |                                        |
  |======== 加密数据传输 ==================|
```

**TLS 1.3 优化点**：

- 减少握手次数（从 4 次到 1 次）
- 移除不安全的加密算法
- 支持 0-RTT（零往返时间）模式

### 4. 证书验证

#### 证书颁发机构（CA - Certificate Authority）

- **作用**：验证服务器身份，防止中间人攻击
- **流程**：
  1. 服务器向 CA 申请证书
  2. CA 验证服务器身份后颁发证书
  3. 证书包含：服务器公钥、域名、有效期、CA 签名等
  4. 客户端验证证书：
     - 检查证书是否过期
     - 检查证书域名是否匹配
     - 验证 CA 签名（信任链验证）

#### 证书链验证

```
根证书（Root CA）
    ↓
中间证书（Intermediate CA）
    ↓
服务器证书（Server Certificate）
```

### 5. 密钥生成过程

1. **Client Random** + **Server Random** + **Pre-master Secret** → **Master Secret**
2. **Master Secret** → 生成对称加密密钥（Session Key）
3. 后续所有数据传输使用 Session Key 进行对称加密

## 形象比喻：爱情故事

**防中间人攻击**：小明想给小红写情书（数据），但怕被人偷看。

1. **非对称加密阶段**：
   - 小红把打开的"锁"（公钥）发给小明
   - 小明用锁把箱子锁上（加密）
   - 只有小红的"钥匙"（私钥）能开
   - 但锁箱子太慢（性能差）

2. **混合加密方案**：
   - 小明在箱子里放了一把"对称密钥"
   - 之后的情书都用这把对称密钥加解密
   - 又快又安全

**这就是 HTTPS 的混合加密**：

- 先用非对称加密安全传输对称密钥
- 再用对称加密高效传输数据

## 性能考虑

### TLS 1.2 的性能问题

- 需要 4 次握手（2-RTT）
- 非对称加密计算量大
- 首次连接延迟较高

### TLS 1.3 的优化

- 减少到 1 次握手（1-RTT）
- 支持 0-RTT 模式（会话恢复）
- 移除不安全的加密算法
- **HTTPS 性能问题（速度）可以忽略**

## 常见加密算法

### 对称加密算法

- **AES**（Advanced Encryption Standard）：最常用，128/192/256 位
- **DES**：已淘汰（不安全）
- **3DES**：已淘汰（性能差）

### 非对称加密算法

- **RSA**：最常用，基于大数分解
- **ECC**（椭圆曲线加密）：更高效，密钥更短
- **DH**（Diffie-Hellman）：密钥交换算法

### 哈希算法

- **SHA-256**：用于数字签名和完整性验证
- **MD5**：已淘汰（不安全）

## 常见面试问题

1. **HTTP 和 HTTPS 的区别？**
   - 加密、端口、证书、安全性、性能

2. **HTTPS 的握手过程？**
   - TLS 1.2：4 次握手
   - TLS 1.3：1 次握手

3. **为什么使用混合加密？**
   - 非对称加密安全但慢，对称加密快但不安全
   - 混合使用：非对称传密钥，对称传数据

4. **如何防止中间人攻击？**
   - 证书验证（CA 签名）
   - 公钥加密
   - 数字签名验证

5. **TLS 1.3 相比 1.2 的改进？**
   - 减少握手次数
   - 移除不安全算法
   - 支持 0-RTT
